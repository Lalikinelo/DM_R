---
title: "Devoir Maison R"
author: "Larry"
date: "27/09/2021"
output: 
  html_document:
     css: rapport.css
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
library(dplyr)
library(stringr)
library(purrr)
APE_Type=read.csv("C:/Users/Larry/Documents/DM R/Data/APE_Type.csv")
data42=read.csv("C:/Users/Larry/Documents/DM R/Data/geo_siret_42.csv")
```
# 3.1 Mise en place

## 3.1.3 Code et types d’activités => commerces alimentaires
- Nombre d’entreprises ayant un nom (enseigne1Etablissement) qui comprend le terme “BOULANGERIE”: 

```{r Nb_boulangeries, echo=TRUE, message=FALSE, warning=FALSE}
nrow(filter(data42,str_detect(enseigne1Etablissement,"BOULANGERIE"))) 
```

- Ajoutez une variable Code à votre table en ne conservant que les quatre premiers caractères de la variable activitePrincipaleEtablissement
```{r ajout_code, echo=TRUE, message=FALSE, warning=FALSE}
ncol(data42)
data42$code = substring(data42$activitePrincipaleEtablissement , 1, 4)
ncol(data42)
head(data42$code)
```


- Filtrez les lignes de data42 pour ne retenir que celles pour lesquelles l’APE correspond aux commerces “alimentaires” -alimentation, boisson, restaurant, bar
```{r filter_code, echo=TRUE, message=FALSE, warning=FALSE}
nrow(data42) # nb lignes avant filtrage
alim42=filter(data42, data42$code %in% APE_Type$Code)
nrow(alim42) # nb lignes après filtrage
```


- Stockez le résultat de ces opérations dans un objet alim42 (+conversion de la variable "code")

```{r save_alim42, echo=TRUE, message=FALSE, warning=FALSE}
typeof(alim42$code)
alim42$code=as.double(alim42$code)
typeof(alim42$code)
```

- Réalisez une jointure entre data42_alim (variable codeAPE) et APE_Type (variable Code), de manière à compléter alim42 avec les types de commerces

```{r jointure_code, echo=TRUE, message=FALSE, warning=FALSE}
dim(alim42)
alim42=left_join(alim42,APE_Type,by = c("code" = "Code"))
dim(alim42)
```

## 3.1.4 Résumé, classement

- Quelles sont les 3 communes de votre base de données qui comptent le plus de magasins alimentaires?

```{r 3_communes, echo=TRUE, message=FALSE, warning=FALSE}
head(arrange(summarise(group_by(alim42,libelleCommuneEtablissement),nb_com_alimentaire=n()),desc(nb_com_alimentaire)),3)
```
- Pour les communes qui ne comptent qu’un seul commerce “alimentaire”, de quel type est-il, le plus fréquemment?

```{r plus_freq_des_commerces_uniques, message=FALSE, warning=FALSE}
test=summarise(group_by(alim42,libelleCommuneEtablissement),nb_com_alimentaire=n())
test= filter(test,nb_com_alimentaire==1)
test=left_join(test,select(alim42,libelleCommuneEtablissement, TypeAbreg))
print(nrow(test))

test=summarise(group_by(test,TypeAbreg),freq_alim_uniq=n())
head(arrange(test,desc(freq_alim_uniq)),1)
```
- Quelles communes de plus de 100 commerces comptent au moins 10 commerces de type “viande”?

```{r 10_com_de_viandes_dans_villes_de_100_com}
test=summarise(group_by(alim42,libelleCommuneEtablissement),nb_com_alimentaire=n())
test= filter(test,nb_com_alimentaire>100)
test=left_join(test,select(filter(alim42,TypeAbreg=="viande"),libelleCommuneEtablissement, TypeAbreg))
test=summarise(group_by(test,libelleCommuneEtablissement),nb_com_viande=n())
test= filter(test,nb_com_viande>=10)
print(arrange(test,desc(nb_com_viande)))
```

# 3.2 Rapport, statistiques descriptives

- Rédigez un petit paragraphe pour nommer les 3 communes qui comptent le plus d’entreprises (exercice précédent) en utilisant l’insertion d’“inline chunks”.

```{r top_3_commune_max_entr, message=FALSE, warning=FALSE}
test=summarise(group_by(data42,libelleCommuneEtablissement),nb_entreprise=n())
test=head(arrange(test,desc(nb_entreprise)),3)
```


Les communes qui comptent le plus d'entreprises sont :  
1. `r test$libelleCommuneEtablissement[1]`  
2.`r test$libelleCommuneEtablissement[2]`  
3. `r test$libelleCommuneEtablissement[3]`  


# 3.3 Programmation: automatisation pour plusieurs départements

## 3.3.1 Fonction

```{r fonction, echo=TRUE, message=FALSE, warning=FALSE}
get_clean_data  <-function(num_departement){
  
  APE_Type=read.csv("C:/Users/Larry/Documents/DM R/Data/APE_Type.csv")
  
  # Vérification de l'existence de données pour le numéro de département passé en argument
  if (!file.exists(paste("C:/Users/Larry/Documents/DM R/Data/geo_siret_",num_departement,".csv",sep = "", collapse = NULL))){
    message("No data available, try another departement number")
    } 
  else{    
    data_departement=read.csv(paste("C:/Users/Larry/Documents/DM R/Data/geo_siret_",num_departement,".csv",sep = "", collapse = NULL))
     
    # modification du code pour avoir une correspondance avec la base APE_Type
    data_departement$code = substring(data_departement$activitePrincipaleEtablissement , 1, 4)
  
  # Recupération des données concernant l'alimentation 
    alim_departement=filter(data_departement, data_departement$code %in% APE_Type$Code)
  
  # conversion du champ code de string à double
    alim_departement$code=as.double(alim_departement$code)
  
  # conversion du champ code de string à double
    alim_departement$numeroVoieEtablissement=as.integer(alim_departement$numeroVoieEtablissement)
  
  # Récupération du Type de commerce depuis la base APE_Type
    alim_departement=left_join(alim_departement,APE_Type,by = c("code" = "Code"))
  
    return(alim_departement)
  }
}
#test1: Récupère les données du dpt 24 (aucune données)
get_clean_data("24")
#test2: Recupere les données du dpt 42 (données présentes)
print(paste("il y a ",as.character(nrow(get_clean_data("42")))," lignes dans les données geo_siret_42" ,sep = "", collapse = NULL))
```

## 3.3.2 Itération

- Appelez cette fonction de manière itérative pour chacun des départements cités ci-dessus. Vous pouvez pour ce faire soit écrire une boucle for, soit utiliser la fonction map() du package purrr. 
- A partir des 5 jeux de données obtenus vous créerez un seul et même jeu de données alimRA_entr (données pour l’ancienne région Rhône-Alpes, où 1 ligne=1 entreprise).




```{r itération, echo=TRUE, message=FALSE, warning=FALSE}
num_Departement_RA= c("01","38","42","43","69")
alimRA_entr=NULL


# ******************* Methode avec boucle for *****************

#for (i in 1:5)
#  {
#  alimRA_entr=bind_rows(alimRA_entr,get_clean_data(num_Departement_RA[i]))
#  print(paste("geo_siret_",num_Departement_RA[i]," ajouté. Le nombre de lignes de alimRA_entr est : ",nrow(alimRA_entr),sep = "", collapse = NULL))
#  }


# ******************* Methode avec map *****************

alimRA_entr=map(num_Departement_RA,get_clean_data)
alimRA_entr=bind_rows(alimRA_entr)
nrow(alimRA_entr)
```
```

## 3.3.3 If et écriture de fichier

- exportez alimRA_entr dans un fichier alimRA_entr.csv
- entourez la boucle for d’une structure conditionnelle if de sorte que la boucle ne soit exécutée que si le fichier alimRA_entr.csv n’existe pas
- écrivez à la suite la commande qui servira à lire alimRA_entr.csv à chaque “tricotage” de votre rapport Rmarkdown.

```{r export csv, message=FALSE, warning=FALSE}
if(!file.exists("C:/Users/Larry/Documents/DM R/Data/alimRA_entr.csv"))
  {
  write.csv(alimRA_entr,"C:/Users/Larry/Documents/DM R/Data/alimRA_entr.csv", row.names = FALSE)
  }else
  {
  alimRA_entr=APE_Type=read.csv("C:/Users/Larry/Documents/DM R/Data/alimRA_entr.csv")
  }
  if(file.exists("C:/Users/Larry/Documents/DM R/Data/alimRA_entr.csv"))
  {
  print("[TEST] le fichier csv existe...")
  }
```
# 3.4 Résumé par commune et type de commerce

- Agrégez la table alimRA_entr par commune et type de commerce, pour créer une table alimRA_typeCom (où une ligne correspondra à un type de commerce pour une commune):

- Une variable nInCom correspondant au nombre de commerces par commune

- Une variable nInTypeCom correspondant au nombre de commerces par type et commune

- Une variable propInTypeCom correspondant à la proportion d’un type de commerce dans une commune

- Quelles communes comptant plus de 100 commerces comptes au moins 5% de commerces de type “viande”?


```{r}
alimRA_typeCom = summarise(group_by(alimRA_entr,TypeAbreg,libelleCommuneEtablissement),nInTypeCom=n())
alimRA_nInCom= summarise(group_by(alimRA_entr,libelleCommuneEtablissement),nInCom=n())
alimRA_typeCom= arrange (left_join(alimRA_typeCom,select(alimRA_nInCom,libelleCommuneEtablissement, nInCom)),libelleCommuneEtablissement)
alimRA_typeCom$propInTypeCom = alimRA_typeCom$nInTypeCom /alimRA_typeCom$nInCom
print(filter(alimRA_typeCom,nInCom>100 & propInTypeCom>=0.05 & TypeAbreg=="viande"))
```


## 3.4.2 Graphique

- Réalisez un graphique montrant les proportions des différents types de commerces pour LYON 4EME et LYON 8EME.

```{r}
library(ggplot2)
#print(filter(alimRA_typeCom,libelleCommuneEtablissement=="LYON 4EME" | libelleCommuneEtablissement=="LYON 3EME" ))
ggplot(data=filter(alimRA_typeCom,libelleCommuneEtablissement=="LYON 4EME" | libelleCommuneEtablissement=="LYON 8EME" ), aes(x=TypeAbreg, y=propInTypeCom*100, fill=libelleCommuneEtablissement)) +
geom_bar(stat="identity", position=position_dodge())+labs(x="Type de commerce", y="Proportion en %") 
#+  scale_x_discrete(labels = abbreviate)

```

## 3.5 Evolution dans le temps des créations d’entreprise

# 3.5.1 Manipuler des dates avec lubridate


- Installez et chargez le package lubridate.
- Transformez le tableau alimRA_entr en modifiant la classe de dateCreationEtablissement à l’aide d’une fonction de lubridate.
- Ajoutez une variable annee au tableau alimRA_entr à l’aide, à nouveau, d’une des fonctions de lubridate.

```{r}
#install.packages("lubridate")
library(lubridate)


print(paste("type de dateCreationEtablissement : ",class(alimRA_entr$dateCreationEtablissement),sep = "", collapse = NULL))

alimRA_entr$dateCreationEtablissement=ymd(alimRA_entr$dateCreationEtablissement)

print(paste("type de dateCreationEtablissement après ymd() : ",class(alimRA_entr$dateCreationEtablissement),sep = "", collapse = NULL))

alimRA_entr$annee=year(alimRA_entr$dateCreationEtablissement)

alimRA_entr=arrange(alimRA_entr,desc(enseigne1Etablissement))

print(head(paste( alimRA_entr$enseigne1Etablissement," SINCE ",alimRA_entr$annee,sep = "", collapse = NULL)))
```

# 3.5.2 Résumé, filtre


- Créez une table alimRA_typeAn qui recense le **nombre d’entreprises par année (nInAn), et par type*année (nInTypeAn)**.
- Filtrez les données de alimRA_typeAn pour ne garder que les entreprises dont la création correspond aux années >=1970.

```{r}

alimRA_typeAn=left_join(summarise(group_by(alimRA_entr,annee,TypeAbreg),nInTypeAn=n()),summarise(group_by(alimRA_entr,annee),nInAn=n()),by = c("annee" = "annee"))

alimRA_typeAn=filter(alimRA_typeAn,annee>=1970 & annee<2020)
head(alimRA_typeAn)

```

# 3.5.3 Graphiques: évolution du nombre d’entreprises au cours du temps

- Installez et chargez le package ggplot2
- Réalisez un graphique représentant l’évolution des proportions d’entreprises (par type) par année.
- Réalisez ce même graphique, mais en représentant le nombre de créations d’entreprises par année et par type, pour les 5 types comptant le plus de créations d’entreprises (au total).


```{r}


ggplot(alimRA_typeAn, aes(x=annee, y=nInTypeAn/nInAn*100, color=TypeAbreg))+
  geom_line() +labs(y="% de chaque type",title="Evolution des proportions d’entreprises (par type) par année",color="Type d'entreprise")




ggplot(filter(alimRA_typeAn, TypeAbreg %in% head(arrange(summarise(group_by(alimRA_typeAn,TypeAbreg),sumInTypeAn=sum(nInTypeAn)),desc(sumInTypeAn)),5)$TypeAbreg), aes(x=annee, y=nInTypeAn, color=TypeAbreg)) +
  geom_line() +labs(y="Nombre de créations",title="Evolution du nombre de créations d’entreprises par année pour les 5 types comptant le plus de créations d’entreprises au total",color="Type d'entreprise")
  
```
 
## 3.6 Cartes

# 3.6.1 Carte des boulangeries-pâtisseries


- Repartez de la table alim_entr pour en faire un objet de classe “sf”. Vous vous servirez pour cela des colonnes “longitude” et “latitude” et exclurez les entreprises pour lesquelles ces colonnes ne sont pas renseignées.  
- Réalisez une carte montrant le semis de points correspondant aux boulangeries-pâtisseries.
- Essayez de représenter à travers cette carte l’année de création de l’entreprise (de la manière qui vous semblera la plus pertinente).

```{r}
#install.packages("rgeos")
library(sf)
library("rnaturalearth")
library("rnaturalearthdata")
library(rgeos)


 world = ne_countries(scale = "medium", returnclass = "sf")


points <- st_as_sf(filter(select(alimRA_entr,longitude,latitude,dateCreationEtablissement,TypeAbreg), !is.na(longitude) & !is.na(latitude) & latitude>40 & TypeAbreg=="boulPatiss") , coords = c("longitude", "latitude"), crs = 4326, agr = "constant")

points$dateCreationEtablissement=year(ymd(points$dateCreationEtablissement))

 

#test=data.matrix(filter(select(alimRA_entr,longitude,latitude), #!is.na(longitude) & !is.na(latitude) & latitude>40))


#points=st_multipoint(x = test ,dim="XY")
#ggplot(points)+geom_sf()+
# geom_text(data = nc3_coords, aes(X, Y, label = NAME), colour = "white")

```



# 3.6.2 Carte des proportions de commerce par commune

- Téléchargez le shapefile des limites de communes en France ici et filtrez pour ne garder que les départements considérés ci-dessus.
- Joignez aux communes les informations concernant les commerces (st_join()…) et calculez le nombre de commerces par commune.
- Produisez une carte montrant le nombre de commerces par commune. Vous aurez sans doute à retravailler l’échelle colorée…


filter(departement,num_dep %in% num_Departement_RA)
st_join(departement,points,option=count())


