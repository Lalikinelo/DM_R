---
title: "Devoir Maison R"
author: "Larry"
date: "27/09/2021"
output: 
  html_document:
     css: rapport.css
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
library(dplyr)
library(stringr)

APE_Type=read.csv("E:/Geonum/M2/R/DM_R-main/DM_R-main/data/APE_Type.csv")
data42=read.csv("E:/Geonum/M2/R/DM_R-main/DM_R-main/data/geo_siret_42.csv")
```
# 3.1 Mise en place

## 3.1.3 Code et types d’activités => commerces alimentaires
- Nombre d’entreprises ayant un nom (enseigne1Etablissement) qui comprend le terme “BOULANGERIE”: 

```{r Nb_boulangeries, echo=TRUE, message=FALSE, warning=FALSE}
nrow(filter(data42,str_detect(enseigne1Etablissement,"BOULANGERIE"))) 
```

- Ajoutez une variable Code à votre table en ne conservant que les quatre premiers caractères de la variable activitePrincipaleEtablissement
```{r ajout_code, echo=TRUE, message=FALSE, warning=FALSE}
ncol(data42)
data42$code = substring(data42$activitePrincipaleEtablissement , 1, 4)
ncol(data42)
head(data42$code)
```


- Filtrez les lignes de data42 pour ne retenir que celles pour lesquelles l’APE correspond aux commerces “alimentaires” -alimentation, boisson, restaurant, bar
```{r filter_code, echo=TRUE, message=FALSE, warning=FALSE}
nrow(data42) # nb lignes avant filtrage
alim42=filter(data42, data42$code %in% APE_Type$Code)
nrow(alim42) # nb lignes après filtrage
```


- Stockez le résultat de ces opérations dans un objet alim42 (+conversion de la variable "code")

```{r save_alim42, echo=TRUE, message=FALSE, warning=FALSE}

typeof(alim42$code)
alim42$code=as.double(alim42$code)
typeof(alim42$code)
```

- Réalisez une jointure entre data42_alim (variable codeAPE) et APE_Type (variable Code), de manière à compléter alim42 avec les types de commerces

```{r jointure_code, echo=TRUE, message=FALSE, warning=FALSE}

dim(alim42)
alim42=left_join(alim42,APE_Type,by = c("code" = "Code"))
dim(alim42)
```

## 3.1.4 Résumé, classement

- Quelles sont les 3 communes de votre base de données qui comptent le plus de magasins alimentaires?

```{r 3_communes, echo=TRUE, message=FALSE, warning=FALSE}
head(arrange(summarise(group_by(alim42,libelleCommuneEtablissement),nb_com_alimentaire=n()),desc(nb_com_alimentaire)),3)
```
- Pour les communes qui ne comptent qu’un seul commerce “alimentaire”, de quel type est-il, le plus fréquemment?

```{r plus_freq_des_commerces_uniques, message=FALSE, warning=FALSE}

test=summarise(group_by(alim42,libelleCommuneEtablissement),nb_com_alimentaire=n())
test= filter(test,nb_com_alimentaire==1)

test=left_join(test,select(alim42,libelleCommuneEtablissement, TypeAbreg))

test=summarise(group_by(test,TypeAbreg),freq_alim_uniq=n())
head(arrange(test,desc(freq_alim_uniq)),1)

```
- Quelles communes de plus de 100 commerces comptent au moins 10 commerces de type “viande”?

```{r 10_com_de_viandes_dans_villes_de_100_com}
test=summarise(group_by(alim42,libelleCommuneEtablissement),nb_com_alimentaire=n())
test= filter(test,nb_com_alimentaire>100)
test=left_join(test,select(alim42,libelleCommuneEtablissement, TypeAbreg))

test= filter(test,TypeAbreg=="viande")
test=summarise(group_by(test,libelleCommuneEtablissement),nb_com_viande=n())
test= filter(test,nb_com_viande>=10)
print(arrange(test,desc(nb_com_viande)))
```

# 3.2 Rapport, statistiques descriptives

- Rédigez un petit paragraphe pour nommer les 3 communes qui comptent le plus d’entreprises (exercice précédent) en utilisant l’insertion d’“inline chunks”.

```{r top_3_commune_max_entr, message=FALSE, warning=FALSE}
test=summarise(group_by(data42,libelleCommuneEtablissement),nb_entreprise=n())
test=head(arrange(test,desc(nb_entreprise)),3)

```


Les communes qui comptent le plus d'entreprises sont :  
1. `r test$libelleCommuneEtablissement[1]`  
2.`r test$libelleCommuneEtablissement[2]`  
3. `r test$libelleCommuneEtablissement[3]`  


# 3.3 Programmation: automatisation pour plusieurs départements

## 3.3.1 Fonction

```{r fonction, echo=TRUE, message=FALSE, warning=FALSE}
get_clean_data  <-function(num_departement){
  
  APE_Type=read.csv("E:/Geonum/M2/R/DM_R-main/DM_R-main/data/APE_Type.csv")
  
  # Vérification de l'existence de données pour le numéro de département passé en argument
  if (!file.exists(paste("E:/Geonum/M2/R/DM_R-main/DM_R-main/data/geo_siret_",num_departement,".csv",sep = "", collapse = NULL))){
    message("No data available, try another departement number")
    } 
  else{    
    data_departement=read.csv(paste("E:/Geonum/M2/R/DM_R-main/DM_R-main/data/geo_siret_",num_departement,".csv",sep = "", collapse = NULL))
     
    # modification du code pour avoir une correspondance avec la base APE_Type
    data_departement$code = substring(data_departement$activitePrincipaleEtablissement , 1, 4)
  
  # Recupération des données concernant l'alimentation 
    alim_departement=filter(data_departement, data_departement$code %in% APE_Type$Code)
  
  # conversion du champ code de string à double
    alim_departement$code=as.double(alim_departement$code)
  
  # conversion du champ code de string à double
    alim_departement$numeroVoieEtablissement=as.integer(alim_departement$numeroVoieEtablissement)
  
  # Récupération du Type de commerce depuis la base APE_Type
    alim_departement=left_join(alim_departement,APE_Type,by = c("code" = "Code"))
  
    return(alim_departement)
  }
}
#test1: Récupère les données du dpt 24 (aucune données)
get_clean_data("24")
#test2: Recupere les données du dpt 42 (données présentes)
print(paste("il y a ",as.character(nrow(get_clean_data("42")))," lignes dans les données geo_siret_42" ,sep = "", collapse = NULL))

```

## 3.3.2 Itération

- Appelez cette fonction de manière itérative pour chacun des départements cités ci-dessus. Vous pouvez pour ce faire soit écrire une boucle for, soit utiliser la fonction map() du package purrr. 
- A partir des 5 jeux de données obtenus vous créerez un seul et même jeu de données alimRA_entr (données pour l’ancienne région Rhône-Alpes, où 1 ligne=1 entreprise).

***** A REFAIRE AVEC LA FONCTION MAP ****
liste avec les chemins vers les csv puis map(,read_csv)


```{r itération, echo=TRUE, message=FALSE, warning=FALSE}
num_Departement_RA= c("01","38","42","43","69")
alimRA_entr=NULL

for (i in 1:5)
  {
  alimRA_entr=bind_rows(alimRA_entr,get_clean_data(num_Departement_RA[i]))
  print(paste("geo_siret_",num_Departement_RA[i]," ajouté. Le nombre de lignes de alimRA_entr est : ",nrow(alimRA_entr),sep = "", collapse = NULL))
  }

```